# vim: syntax=sh

fase_1()
{
    # Do not install recommended packages
    run0 sed -i 's/^#\?Recommends=.*/Recommends=false/' /etc/rpm-ostreed.conf

    # Add Brave Repository
    run0 curl --tlsv1.3 -fsSLo /etc/yum.repos.d/brave-browser.repo \
        https://brave-browser-rpm-release.s3.brave.com/brave-browser.repo

    # Add Mullvad Repository
    run0 curl --tlsv1.3 -fsSLo /etc/yum.repos.d/mullvad.repo \
        https://repository.mullvad.net/rpm/stable/mullvad.repo

    # Install Packages
    rpm-ostree update --install \
        brave-browser \
        mullvad-vpn \
        neovim \
        wayvnc \
        zsh

    # Disable System Services
    systemctl disable \
        cups.service cups.socket cups.path \
        ModemManager.service \
        sddm.service

    # TODO: Find a way to cleanly disable the following services
    # blueman-mechanism.service
    # bluetooth.service
    # geoclue.service
    # mpris-proxy.service
    # obex.service

    # Update GRUB timeout
    echo "set timeout=0" | run0 tee /boot/grub2/user.cfg

    # Fase 1 Done
    echo "fase 1 done" > "${HOME}/chezmoi_install"

    # Reboot
    systemctl reboot
}

fase_2()
{
    # Enable Mullvad VPN
    systemctl enable --now mullvad-daemon.service
    systemctl enable --now mullvad-early-boot-blocking.service

    # Change Shell to ZSH
    chsh --shell=/usr/bin/zsh

    # Add Flathub
    flatpak remote-add --user --if-not-exists \
        flathub https://dl.flathub.org/repo/flathub.flatpakrepo

    # Install Flatpaks
    flatpak install --user --assumeyes \
        com.github.tchx84.Flatseal \
        org.keepassxc.KeePassXC \
        org.libreoffice.LibreOffice \
        org.qbittorrent.qBittorrent \
        com.visualstudio.code

    # Fase 2 Done
    echo "fase 2 done" >> "${HOME}/chezmoi_install"
}

if [ ! -f "${HOME}/chezmoi_install" ]; then
    echo "Chezmoi Auto Install: Fase 1"
    #fase_1
else
    echo "Chezmoi Auto Install: Fase 2"
    #fase_2
fi
